services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: budget_api
    ports:
      - "8080:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # KORRIGERAD: Använd "db" som host istället för localhost när du kör inuti Docker
      - ConnectionStrings__DefaultConnection=Host=db;Port=5432;Database=budget_app;Username=postgresql;Password=jagvillanvändaettbättrelösen
      # Lägg även till variabeln för Ollama så backend hittar den i nätverket
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network

  frontend_react:
    build:
      context: ./frontend/react-app
      dockerfile: Dockerfile
      args:
        # VIKTIGT: Denna port måste matcha det du exponerar i "api"-tjänsten ovan
        - VITE_API_URL=http://localhost:8080/api
    container_name: budget_frontend_react
    ports:
      - "3002:80"
    depends_on:
      - api
    networks:
      - app-network

  db:
    image: postgres:16
    container_name: budget_db
    environment:
      POSTGRES_DB: budget_app
      POSTGRES_USER: postgresql
      POSTGRES_PASSWORD: jagvillanvändaettbättrelösen
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgresql -d budget_app"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  pgadmin:
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network
    volumes:
      - pgadmin-data:/var/lib/pgadmin

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - app-network

  ollama-init:
    image: ollama/ollama:latest
    container_name: ollama-init
    networks:
      - app-network
    depends_on:
      - ollama
    volumes:
      - ollama_data:/root/.ollama
    entrypoint: /bin/sh
    command: -c "sleep 5 && OLLAMA_HOST=ollama:11434 ollama pull mistral"
    restart: "no"

networks:
  app-network:
    driver: bridge

volumes:
  db-data:
  pgadmin-data:
  ollama_data:
